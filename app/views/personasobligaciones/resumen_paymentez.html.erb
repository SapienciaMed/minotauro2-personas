<section class="payment-gateway">
  <div class="payment-container">

    <!-- Header -->
    <div class="payment-header">
      <h1><i class="fa fa-credit-card"></i> Finalizar Pago</h1>
      <p class="text-muted">Pago seguro • <%= Time.now.strftime('%d de %B de %Y • %I:%M %p') %></p>
    </div>

    <!-- RESUMEN COMPACTO EN FORMA DE TARJETA -->
    <div class="summary-compact-card">
      <div class="card-header-title">
        <h3>Detalles de la Obligación</h3>
      </div>
      <div class="card-body-table">
        <table class="summary-table">
          <tr>
            <td><strong>Beneficiario</strong></td>
            <td class="text-right"><%= @personasobligacion.persona.nombre_completo rescue 'No disponible' %></td>
          </tr>
          <tr>
            <td><strong>Identificación</strong></td>
            <td class="text-right"><%= @personasobligacion.persona.identificacion rescue 'N/A' %></td>
          </tr>
          <% if @personasobligacion.persona.email.present? %>
            <tr>
              <td><strong>Correo</strong></td>
              <td class="text-right"><%= @personasobligacion.persona.email rescue 'N/A' %></td>
            </tr>
          <% end %>
          <tr class="highlight-row">
            <td><strong>N° de Obligación</strong></td>
            <td class="text-right obligation-number"><%= @personasobligacion.nro_obligacion %></td>
          </tr>
          <tr class="total-row">
            <td><strong>Total a Pagar</strong></td>
            <td class="text-right total-price">
              $<%= number_with_delimiter(@personasoblrecibo.valor&.to_i || 0, delimiter: '.') %>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!-- MÉTODOS DE PAGO -->
    <div class="payment-methods">
      <h3 class="text-center mb-4">Selecciona tu método de pago</h3>

      <div class="methods-grid">
        <!-- ePayco -->
<!--        <div class="method-card recommended">-->
<!--          <div class="recommended-badge">Recomendado</div>-->
<!--          <div class="method-logo">-->
            <%#= image_tag('epayco.png', alt: 'Epayco', height: 45) %>
<!--            <div class="method-name">ePayco</div>-->
<!--          </div>-->
<!--          <p class="method-desc">Tarjetas • PSE • Efecty • Baloto • Nequi</p>-->
<!--          <button id="btn-epayco"-->
<!--                  class="btn-pay btn-epayco"-->
<!--                  data-id="<%#= @personasobligacion.id %>"-->
<!--                  data-valor="<%#= @valor %>"-->
<!--                  data-recibo="<%#= @personasoblrecibo.id %>">-->
<!--            <i class="fa fa-lock"></i> Pagar con ePayco-->
<!--          </button>-->
<!--        </div>-->

        <!-- Paymentez -->
        <div class="method-card">
          <div class="method-logo">
            <%= image_tag('logo-paymentez.png', alt: 'Paymentez', height: 45) %>
            <div class="method-name">Paymentez</div>
          </div>
          <p class="method-desc">Visa • MasterCard • Amex</p>
          <%= link_to pago_paymentez_ws_path(id: @personasobligacion.id, valor: @valor, personasoblrecibo_id: @personasoblrecibo.id),
                      method: :post, class: "btn-pay btn-paymentez" do %>
            <i class="fa fa-credit-card"></i> Pagar con Paymentez
          <% end %>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="payment-footer">
      <div class="security-info">
        <i class="fa fa-shield"></i> Pago 100% seguro • Certificado PCI DSS
      </div>
      <%= link_to root_path, class: "btn-back" do %>
        <i class="fa fa-arrow-left"></i> Volver
      <% end %>
    </div>
  </div>
</section>

<!-- Scripts (sin cambios) -->
<script src="https://checkout.epayco.co/checkout-v2.js"></script>
<script type="text/javascript">
    document.getElementById("btn-epayco").addEventListener("click", function () {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Procesando...';

        fetch(`/pago_epayco_ws?id=${btn.dataset.id}&valor=${btn.dataset.valor}&personasoblrecibo_id=${btn.dataset.recibo}`, {
            method: "POST",
            headers: { "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content }
        })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Error: " + data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa fa-lock"></i> Pagar con ePayco';
                    return;
                }
                ePayco.checkout.configure({
                    sessionId: data.session_id,
                    type: "onepage",
                    test: <%= Rails.env.development? || Rails.env.test? %>
                }).open();
            })
            .catch(() => {
                alert("Error de conexión");
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-lock"></i> Pagar con ePayco';
            });
    });
</script>

<!-- ESTILOS MEJORADOS Y COMPACTOS -->
<style>
    .payment-gateway {
        min-height: 100vh;
        padding: 30px 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Segoe UI', sans-serif;
    }

    .payment-container {
        max-width: 860px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .payment-header {
        background: #000;
        color: white;
        padding: 25px;
        text-align: center;
    }

    .payment-header h1 { margin: 0; font-size: 2rem; }
    .payment-header p { margin: 8px 0 0; font-size: 0.95rem; opacity: 0.9; }

    /* TARJETA COMPACTA CON TABLA */
    .summary-compact-card {
        margin: 25px;
        background: white;
        border-radius: 16px;
        border: 1px solid #eee;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .card-header-title {
        background: #f8f9fa;
        padding: 14px 20px;
        border-bottom: 1px solid #eee;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .card-body-table {
        padding: 0;
    }

    .summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.98rem;
    }

    .summary-table td {
        padding: 12px 20px;
        border-bottom: 1px dashed #eee;
    }

    .summary-table tr:last-child td { border-bottom: none; }

    .summary-table td:first-child {
        color: #555;
        font-weight: 500;
    }

    .summary-table td.text-right {
        text-align: right;
        font-weight: 600;
    }

    .highlight-row {
        background: #fff9e6 !important;
        font-size: 1.05rem;
    }

    .obligation-number {
        color: #d32f2f;
        font-size: 1.15rem;
        font-weight: bold;
    }

    .total-row {
        background: #e8f5e8 !important;
        font-size: 1.25rem;
    }

    .total-price {
        color: #2e7d32;
        font-weight: bold;
        font-size: 1.4rem;
    }

    /* Métodos de pago */
    .payment-methods {
        padding: 10px 30px 40px;
    }

    .methods-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    @media (max-width: 768px) {
        .methods-grid { grid-template-columns: 1fr; }
        .payment-container { margin: 0 10px; }
    }

    .method-card {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .method-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.12);
    }

    .method-card.recommended {
        border-color: #4caf50;
        background: #f1fdf1;
    }

    .recommended-badge {
        position: absolute;
        top: -10px;
        right: 18px;
        background: #4caf50;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .method-name {
        margin-top: 10px;
        font-size: 1.25rem;
        font-weight: 600;
        color: #000;
    }

    .method-desc {
        color: #666;
        margin: 12px 0;
        font-size: 0.92rem;
    }

    .btn-pay {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-epayco { background: linear-gradient(45deg, #00c853, #00b248); color: white; }
    .btn-paymentez { background: linear-gradient(45deg, #9c27b0, #7b1fa2); color: white; text-decoration: none; display: block; text-align: center; }

    .btn-pay:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.2);    color: white;}

    .payment-footer {
        background: #000;
        color: white;
        padding: 18px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }

    .btn-back {
        background: rgba(255,255,255,0.2);
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        color: white;
        transition: 0.3s;
    }

    .btn-back:hover { background: rgba(255,255,255,0.3); }
</style>